<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>ÎÑà Î∞©Í∏à Î≠êÎùºÍ≥† ÌñàÏñ¥?</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; font-family: 'Noto Sans KR', 'Inter', sans-serif; overflow: hidden; }
      
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 3px; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.4); }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>

    <!-- Import Map for Modules -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "@google/genai": "https://esm.sh/@google/genai@0.1.1",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
  <link rel="stylesheet" href="/index.css">
</head>
  <body>
    <div id="root"></div>

    <!-- Process Env Polyfill -->
    <script>
      window.process = window.process || { env: { API_KEY: '' } };
    </script>

    <!-- Main Application Script -->
    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useMemo } from "react";
      import { createRoot } from "react-dom/client";
      import { GoogleGenAI, Type } from "@google/genai";

      // --- 1. Types & Enums (Converted to JS Objects) ---
      const CharacterId = {
        JAPAN: 'japan',
        USA: 'usa',
        FRANCE: 'france',
        BRAZIL: 'brazil',
        KOREA: 'korea',
        UK: 'uk',
        GREECE: 'greece',
        VIETNAM: 'vietnam',
        CHINA: 'china',
        IRAN: 'iran',
        AUSTRALIA: 'australia'
      };

      const Emotion = {
        HAPPY: 'happy',
        SURPRISED: 'surprised',
        CONFUSED: 'confused',
        EXCITED: 'excited',
        NEUTRAL: 'neutral',
        POSITIVE: 'positive',
        NEGATIVE: 'negative'
      };

      // --- 2. Constants ---
      const CHARACTERS = [
        {
          id: CharacterId.FRANCE,
          name: "Louis",
          country: "France",
          color: "bg-indigo-900",
          textColor: "text-indigo-100",
          description: "ÏÑ∏Î†®Îêú ÌîÑÎûëÏä§ ÎÇ®ÏÑ±.",
          images: {
            default: "https://i.imgur.com/z1fnoyg.png",
            positive: "https://i.imgur.com/z1fnoyg.png",
            negative: "https://i.imgur.com/p5wHmwP.png"
          }
        },
        {
          id: CharacterId.IRAN,
          name: "Reza",
          country: "Iran",
          color: "bg-stone-800",
          textColor: "text-stone-100",
          description: "ÌòÑÎåÄÏ†ÅÏù∏ Ïù¥ÎûÄ ÎÇ®ÏÑ±.",
          images: {
            default: "https://i.imgur.com/D9qVE53.png",
            positive: "https://i.imgur.com/D9qVE53.png",
            negative: "https://i.imgur.com/2Mot1Kx.png"
          }
        },
        {
          id: CharacterId.JAPAN,
          name: "Kenji",
          country: "Japan",
          color: "bg-rose-900",
          textColor: "text-rose-100",
          description: "Ï†äÏùÄ ÏùºÎ≥∏ ÎÇ®ÏÑ±.",
          images: {
            default: "https://i.imgur.com/kwgNZJN.png",
            positive: "https://i.imgur.com/kwgNZJN.png",
            negative: "https://i.imgur.com/ygbmB4I.png"
          }
        },
        {
          id: CharacterId.USA,
          name: "Mike",
          country: "USA",
          color: "bg-blue-900",
          textColor: "text-blue-100",
          description: "Ï†äÏùÄ ÎØ∏Íµ≠ ÎÇ®ÏÑ±.",
          images: {
            default: "https://i.imgur.com/7SmjYqQ.png",
            positive: "https://i.imgur.com/7SmjYqQ.png",
            negative: "https://i.imgur.com/7GJhlqS.png"
          }
        },
        {
          id: CharacterId.CHINA,
          name: "Wei",
          country: "China",
          color: "bg-emerald-900",
          textColor: "text-emerald-100",
          description: "Ï§ëÍµ≠ ÎÇ®ÏÑ±.",
          images: {
            default: "https://i.imgur.com/8Q0wX7t.png",
            positive: "https://i.imgur.com/8Q0wX7t.png",
            negative: "https://i.imgur.com/YUIayKK.png"
          }
        },
        {
          id: CharacterId.KOREA,
          name: "Minji",
          country: "Korea",
          color: "bg-pink-900",
          textColor: "text-purple-100",
          description: "Ïä§ÌÉÄÏùºÎ¶¨ÏãúÌïú ÌïúÍµ≠ Ïó¨ÏÑ±.",
          images: {
            default: "https://i.imgur.com/q6CtsFv.png",
            positive: "https://i.imgur.com/q6CtsFv.png",
            negative: "https://i.imgur.com/q6CtsFv.png"
          }
        },
        {
          id: CharacterId.BRAZIL,
          name: "Camila",
          country: "Brazil",
          color: "bg-orange-900",
          textColor: "text-yellow-100",
          description: "ÏæåÌôúÌïú Î∏åÎùºÏßà Ïó¨ÏÑ±.",
          images: {
            default: "https://i.imgur.com/siSE3Lo.png",
            positive: "https://i.imgur.com/siSE3Lo.png",
            negative: "https://i.imgur.com/GG1EHzs.png"
          }
        },
        {
          id: CharacterId.UK,
          name: "Olivia",
          country: "UK",
          color: "bg-red-900",
          textColor: "text-red-100",
          description: "ÏòÅÍµ≠ Ïó¨ÏÑ±.",
          images: {
            default: "https://i.imgur.com/utD04N9.png",
            positive: "https://i.imgur.com/utD04N9.png",
            negative: "https://i.imgur.com/NmcKRbG.png"
          }
        },
        {
          id: CharacterId.GREECE,
          name: "Nikos",
          country: "Greece",
          color: "bg-cyan-900",
          textColor: "text-cyan-100",
          description: "Í∑∏Î¶¨Ïä§ ÎÇ®ÏÑ±.",
          images: {
            default: "https://i.imgur.com/YOkJPH5.png",
            positive: "https://i.imgur.com/YOkJPH5.png",
            negative: "https://i.imgur.com/E9tL3YH.png"
          }
        },
        {
          id: CharacterId.VIETNAM,
          name: "Linh",
          country: "Vietnam",
          color: "bg-emerald-900",
          textColor: "text-emerald-100",
          description: "Î≤†Ìä∏ÎÇ® Ïó¨ÏÑ±.",
          images: {
            default: "https://i.imgur.com/LDaDwya.png",
            positive: "https://i.imgur.com/LDaDwya.png",
            negative: "https://i.imgur.com/Qmmn3lx.png"
          }
        },
        {
          id: CharacterId.AUSTRALIA,
          name: "Liam",
          country: "Australia",
          color: "bg-orange-800",
          textColor: "text-orange-100",
          description: "Ìò∏Ï£º ÎÇ®ÏÑ±.",
          images: {
            default: "https://i.imgur.com/li2sV02.png",
            positive: "https://i.imgur.com/li2sV02.png",
            negative: "https://i.imgur.com/iMAQNKm.png"
          }
        }
      ];

      const DEFAULT_CHARACTERS = [
        CharacterId.FRANCE,
        CharacterId.IRAN,
        CharacterId.JAPAN,
        CharacterId.USA
      ];

      const GESTURES = [
        {
          id: "thumbs_up",
          label: "Thumbs Up",
          icon: "https://i.imgur.com/uGRSLpc.png",
          prompt: "ÏÇ¨Ïö©ÏûêÍ∞Ä ÏóÑÏßÄ Ï≤ô Ï†úÏä§Ï≤òÎ•º Ï∑®ÌñàÏäµÎãàÎã§.",
          relatedCharacters: [CharacterId.USA, CharacterId.KOREA, CharacterId.IRAN, CharacterId.AUSTRALIA],
          culturalNote: [
              { characterId: CharacterId.IRAN, note: "Î™®Ïöï!", isNegative: true },
              { characterId: CharacterId.AUSTRALIA, note: "Î¨¥Î°ÄÌï®!", isNegative: true },
              { characterId: CharacterId.USA, note: "Ï¢ãÏïÑÏöî!" },
              { characterId: CharacterId.KOREA, note: "ÏµúÍ≥†!" }
          ]
        },
        {
          id: "v_sign",
          label: "V Sign",
          icon: "https://i.imgur.com/Atdb3nG.png",
          prompt: "ÏÇ¨Ïö©ÏûêÍ∞Ä Î∏åÏù¥(V) Ï†úÏä§Ï≤òÎ•º Ï∑®ÌñàÏäµÎãàÎã§.",
          relatedCharacters: [CharacterId.KOREA, CharacterId.USA, CharacterId.UK, CharacterId.AUSTRALIA],
          culturalNote: [
              { characterId: CharacterId.UK, note: "Î™®Ïöï! (ÏÜêÎì± Î≥¥ÏùºÏãú)", isNegative: true },
              { characterId: CharacterId.KOREA, note: "Í∑ÄÏó¨Ïö¥ Ìè¨Ï¶à" },
              { characterId: CharacterId.USA, note: "ÌèâÌôî" }
          ]
        },
        {
          id: "ok_sign",
          label: "OK Sign",
          icon: "https://i.imgur.com/j0xZ5AP.png",
          prompt: "ÏÇ¨Ïö©ÏûêÍ∞Ä OK ÏÇ¨Ïù∏ÏùÑ Î≥¥ÎÉàÏäµÎãàÎã§.",
          relatedCharacters: [CharacterId.USA, CharacterId.FRANCE, CharacterId.BRAZIL, CharacterId.KOREA],
          culturalNote: [
              { characterId: CharacterId.BRAZIL, note: "Ïã¨Ìïú Î™®Ïöï!", isNegative: true },
              { characterId: CharacterId.FRANCE, note: "Ïì∏Î™®ÏóÜÏùå / 0", isNegative: true },
              { characterId: CharacterId.USA, note: "ÏôÑÎ≤ΩÌï¥" }
          ]
        },
        {
          id: "call_me",
          label: "Call Me",
          icon: "https://i.imgur.com/CTbRPTO.png",
          prompt: "ÏÇ¨Ïö©ÏûêÍ∞Ä 'Ï†ÑÌôîÌï¥' Ï†úÏä§Ï≤òÎ•º Ï∑®ÌñàÏäµÎãàÎã§.",
          relatedCharacters: [CharacterId.USA, CharacterId.CHINA, CharacterId.KOREA, CharacterId.BRAZIL],
          culturalNote: [
              { characterId: CharacterId.CHINA, note: "6 (Ïà´Ïûê)", isNegative: false },
              { characterId: CharacterId.USA, note: "Ï†ÑÌôîÌï¥Ï§ò" }
          ]
        },
        {
          id: "crossed_fingers",
          label: "Crossed Fingers",
          icon: "https://i.imgur.com/6iSs6LM.png",
          prompt: "ÏÇ¨Ïö©ÏûêÍ∞Ä ÏÜêÍ∞ÄÎùΩÏùÑ ÍµêÏ∞®ÌñàÏäµÎãàÎã§(Crossed Fingers).",
          relatedCharacters: [CharacterId.USA, CharacterId.VIETNAM, CharacterId.UK, CharacterId.FRANCE],
          culturalNote: [
              { characterId: CharacterId.VIETNAM, note: "ÏÑ±Ï†Å Î™®Ïöï!", isNegative: true },
              { characterId: CharacterId.USA, note: "ÌñâÏö¥ÏùÑ ÎπåÏñ¥" }
          ]
        },
        {
          id: "stop_palm",
          label: "Stop",
          icon: "https://i.imgur.com/eme6I4i.png",
          prompt: "ÏÇ¨Ïö©ÏûêÍ∞Ä ÏÜêÎ∞îÎã•ÏùÑ Ìé¥ÏÑú 'Î©àÏ∂∞' Ïã†Ìò∏Î•º Î≥¥ÎÉàÏäµÎãàÎã§.",
          relatedCharacters: [CharacterId.USA, CharacterId.GREECE, CharacterId.IRAN, CharacterId.JAPAN],
          culturalNote: [
              { characterId: CharacterId.GREECE, note: "Î™®Ïöï (Moutza)!", isNegative: true },
              { characterId: CharacterId.IRAN, note: "Î¨¥Î°ÄÌï®!", isNegative: true },
              { characterId: CharacterId.USA, note: "Ï†ïÏßÄ" }
          ]
        },
        {
          id: "two_hands",
          label: "Respect",
          icon: "https://i.imgur.com/XLesUSL.png",
          prompt: "ÏÇ¨Ïö©ÏûêÍ∞Ä Îëê ÏÜêÏùÑ Î™®ÏïÑ ÎÇ¥Î∞ÄÏóàÏäµÎãàÎã§.",
          relatedCharacters: [CharacterId.KOREA, CharacterId.JAPAN, CharacterId.USA, CharacterId.FRANCE],
          culturalNote: [
              { characterId: CharacterId.KOREA, note: "Ï°¥Ï§ë / Í≥µÏÜê" },
              { characterId: CharacterId.USA, note: "ÎÑàÎ¨¥ Í≤©ÏãùÏ∞®Î¶º / Íµ¨Í±∏?" }
          ]
        },
        {
          id: "rock_on",
          label: "Rock On",
          icon: "https://i.imgur.com/eMVh3F9.png",
          prompt: "ÏÇ¨Ïö©ÏûêÍ∞Ä Í≤ÄÏßÄÏôÄ ÏÉàÎÅºÏÜêÍ∞ÄÎùΩÏùÑ Ìé¥ÏÑú 'Rock On' Ï†úÏä§Ï≤òÎ•º Ï∑®ÌñàÏäµÎãàÎã§.",
          relatedCharacters: [CharacterId.USA, CharacterId.BRAZIL, CharacterId.UK, CharacterId.KOREA],
          culturalNote: [
              { characterId: CharacterId.BRAZIL, note: "Î∞∞Ïö∞Ïûê Î∞îÎûåÎÇ®(Î™®Ïöï)!", isNegative: true },
              { characterId: CharacterId.USA, note: "Rock n Roll!" },
              { characterId: CharacterId.KOREA, note: "Ïã†ÎÇò!" },
              { characterId: CharacterId.UK, note: "Rock!" }
          ]
        }
      ];

      // --- 3. Gemini Service ---
      const ai = new GoogleGenAI({ apiKey: process.env.API_KEY || '' });

      const CULTURAL_GUIDELINES = `
        REFERENCE RULES FOR GESTURES (KOREAN CONTEXT):
        1) Thumbs Up (üëç): Iran/Australia (Rude), West (Good).
        2) V Sign (‚úåÔ∏è): UK/Australia (Back of hand = Insult), Korea (Cute).
        3) OK Gesture (üëå): France (Zero/Worthless), Brazil (Insult), West (OK).
        4) Call Me (ü§ô): China (6), West (Phone).
        5) Crossed Fingers (ü§û): Vietnam (Insult), West (Luck).
        6) Stop/Palm (‚úã): Greece (Moutza/Insult), West (Stop).
        7) Two Hands (ü§≤): Korea/Japan (Respect), West (Begging/Formal).
        8) Rock On (ü§ò): Brazil/Mediterranean (Corna/Cheating Spouse - Insult), West (Rock).
      `;

      // Schema for Gemini JSON response
      const ReactionSchema = {
        type: Type.ARRAY,
        items: {
          type: Type.OBJECT,
          properties: {
            characterId: { type: Type.STRING },
            dialogue: { type: Type.STRING },
            emotion: { type: Type.STRING, enum: Object.values(Emotion) },
            actionDescription: { type: Type.STRING }
          },
          required: ["characterId", "dialogue", "emotion", "actionDescription"]
        }
      };

      const fetchReactions = async (gesturePrompt, activeCharacters) => {
        if (!process.env.API_KEY) {
            console.warn("API Key is missing. Returning fallback response.");
            return activeCharacters.map(c => ({
                characterId: c.id,
                dialogue: "API KeyÍ∞Ä ÌïÑÏöîÌï¥Ïöî!",
                emotion: "neutral",
                actionDescription: "Ïò§Î•ò Î∞úÏÉù"
            }));
        }

        const model = "gemini-2.5-flash";
        const characterContext = activeCharacters.map(c => 
          `${c.name} (${c.country}): ${c.description} (ID: ${c.id})`
        ).join("\n");

        const prompt = `
          ÎãπÏã†ÏùÄ 4Î™ÖÏùò ÏÑúÎ°ú Îã§Î•∏ Î¨∏ÌôîÍ∂å Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÏûàÎäî Ïõπ ÌéòÏù¥ÏßÄÎ•º Ïï†ÎãàÎ©îÏù¥ÏÖòÌôîÌïòÍ≥† ÏûàÏäµÎãàÎã§.
          ÏÇ¨Ïö©ÏûêÍ∞Ä Îã§Ïùå ÌñâÎèôÏùÑ ÌñàÏäµÎãàÎã§: "${gesturePrompt}".
          
          ${CULTURAL_GUIDELINES}

          ÌòÑÏû¨ ÌôîÎ©¥Ïùò Ï∫êÎ¶≠ÌÑ∞Îì§:
          ${characterContext}
          
          ÏßÄÏπ®:
          - ÏúÑ Ï∫êÎ¶≠ÌÑ∞ 4Î™Ö Í∞ÅÍ∞ÅÏóê ÎåÄÌïú Î∞òÏùëÏùÑ JSON ÌòïÏãùÏúºÎ°ú ÏÉùÏÑ±ÌïòÏÑ∏Ïöî.
          - ÏúÑÏùò "Ï†úÏä§Ï≤ò Ï∞∏Ï°∞ Í∑úÏπô"ÏùÑ ÏóÑÍ≤©Ìûà Îî∞Î•¥ÏÑ∏Ïöî.
          - Ï∫êÎ¶≠ÌÑ∞Ïùò Íµ≠Í∞ÄÏóêÏÑú Î™®ÏöïÏ†ÅÏù∏ Ï†úÏä§Ï≤òÎùºÎ©¥, ÌôîÎ•º ÎÇ¥Í±∞ÎÇò Ï∂©Í≤©ÏùÑ Î∞õÏùÄ Î∞òÏùëÏùÑ Î≥¥Ïó¨Ïïº Ìï©ÎãàÎã§.
          - ÌäπÏ†ï ÏùòÎØ∏(Ïòà: ÌîÑÎûëÏä§Ïùò "0")Í∞Ä ÏûàÎã§Î©¥ Í∑∏ ÏùòÎØ∏Î•º Î∞òÏòÅÌïòÏÑ∏Ïöî.
          - 'dialogue': 10Îã®Ïñ¥ Ïù¥ÎÇ¥Ïùò ÏßßÏùÄ ÌïúÍµ≠Ïñ¥ ÎåÄÏÇ¨. Î¨∏ÌôîÏ†ÅÏúºÎ°ú Ï†ÅÏ†àÌïòÍ≤å.
          - 'emotion': [happy, surprised, confused, excited, neutral, positive, negative] Ï§ë ÌïòÎÇò. Î™®ÏöïÏ†ÅÏù¥Î©¥ 'negative' ÎòêÎäî 'surprised' ÏÇ¨Ïö©.
          - 'actionDescription': Ìè¨Ï¶àÏóê ÎåÄÌïú Îß§Ïö∞ ÏßßÏùÄ ÌïúÍµ≠Ïñ¥ Î¨òÏÇ¨.
        `;

        try {
          const response = await ai.models.generateContent({
            model,
            contents: prompt,
            config: {
              responseMimeType: "application/json",
              responseSchema: ReactionSchema,
              temperature: 0.8,
            },
          });

          const text = response.text;
          if (!text) return [];

          return JSON.parse(text);
        } catch (error) {
          console.error("Gemini API Error:", error);
          return activeCharacters.map(c => ({
            characterId: c.id,
            dialogue: "...",
            emotion: "neutral",
            actionDescription: "Í∞ÄÎßåÌûà ÏûàÏùå"
          }));
        }
      };

      // --- 4. Components ---

      const CharacterStrip = ({ profile, reaction, isLoading }) => {
        const [imgError, setImgError] = useState(false);
        
        const isNegative = reaction && !isLoading && (
          reaction.emotion === 'negative' || 
          reaction.emotion === 'confused' || 
          reaction.emotion === 'surprised'
        );
        
        let currentImageUrl = profile?.images?.default;
        if (reaction && !isLoading) {
            if (reaction.emotion === 'positive' || reaction.emotion === 'happy' || reaction.emotion === 'excited') {
              currentImageUrl = profile?.images?.positive;
            } else if (isNegative) {
              currentImageUrl = profile?.images?.negative;
            }
        }

        useEffect(() => {
          setImgError(false);
        }, [profile?.id, currentImageUrl]);

        return (
          <div className={`relative h-full w-full overflow-hidden transition-colors duration-500 ${profile.color} border-x border-white/10 group flex flex-col items-center justify-center`}>
            <div className="absolute inset-0 w-full h-full transition-opacity duration-700">
               {!imgError && currentImageUrl ? (
                   <img 
                     key={currentImageUrl}
                     src={currentImageUrl} 
                     alt={profile.name} 
                     onError={() => setImgError(true)}
                     className={`w-full h-full object-cover animate-[fadeIn_0.5s_ease-out] ${isLoading ? 'blur-sm scale-105 grayscale-[30%]' : 'blur-0 scale-100'}`}
                     style={{ transition: 'filter 0.5s ease, transform 0.5s ease' }}
                   />
               ) : (
                  <div className={`w-full h-full ${profile.color} flex items-center justify-center opacity-50`}>
                     <span className="text-white font-bold">{profile.country}</span>
                  </div>
               )}
               <div className="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-black/10"></div>
            </div>

            <div className="absolute top-4 left-4 z-10 pointer-events-none">
              <h2 className="text-4xl lg:text-6xl font-black uppercase tracking-tighter text-white/20 select-none">
                {profile.country}
              </h2>
            </div>

            <div className="absolute top-8 right-8 z-10 pointer-events-none text-right">
              <p className="text-xs font-bold text-white/90 uppercase tracking-[0.2em] border-b border-white/30 pb-1 mb-1">
                  {profile.name}
              </p>
              <p className="text-[10px] text-white/60 uppercase">
                  {profile.country}
              </p>
            </div>

            <div className={`absolute bottom-[20%] left-1/2 -translate-x-1/2 z-20 w-11/12 max-w-[260px] transition-all duration-500 transform ${reaction && !isLoading ? 'opacity-100 translate-y-0 scale-100' : 'opacity-0 translate-y-8 scale-90 pointer-events-none'}`}>
              <div className={`
                  backdrop-blur-xl p-4 rounded-2xl shadow-2xl border text-center relative transition-colors duration-300
                  ${isNegative 
                      ? 'bg-red-600/90 border-red-500/50 shadow-red-900/50' 
                      : 'bg-white/90 border-white/50 shadow-black/20'
                  }
              `}>
                  <div className={`
                      absolute -bottom-2 left-1/2 -translate-x-1/2 w-4 h-4 rotate-45 border-r border-b transition-colors duration-300
                      ${isNegative 
                          ? 'bg-red-600/90 border-red-500/50' 
                          : 'bg-white/90 border-white/50'
                      }
                  `}></div>
                  
                  <p className={`text-lg font-bold mb-0 leading-tight break-keep transition-colors duration-300 ${isNegative ? 'text-white' : 'text-gray-900'}`}>
                      "{reaction?.dialogue}"
                  </p>
              </div>
            </div>

            {isLoading && (
              <div className="absolute bottom-1/2 left-1/2 -translate-x-1/2 translate-y-1/2 z-20">
                  <div className="flex gap-2">
                      <div className="w-3 h-3 rounded-full bg-white animate-bounce delay-0 shadow-lg"></div>
                      <div className="w-3 h-3 rounded-full bg-white animate-bounce delay-100 shadow-lg"></div>
                      <div className="w-3 h-3 rounded-full bg-white animate-bounce delay-200 shadow-lg"></div>
                  </div>
              </div>
            )}
          </div>
        );
      };

      const GestureControl = ({ onSelectGesture, onHoverGesture, isLoading, selectedGestureId }) => {
        return (
          <div className="fixed bottom-2 left-1/2 -translate-x-1/2 z-50 flex flex-col items-center w-full pointer-events-none">
            <div className="text-center mb-2 pointer-events-auto">
              <p className="text-white/80 text-[10px] font-medium uppercase tracking-[0.2em] animate-pulse bg-black/60 backdrop-blur-md px-4 py-1.5 rounded-full border border-white/10 shadow-lg">
                  {isLoading ? "AI Ï∫êÎ¶≠ÌÑ∞ Î∂ÑÏÑù Ï§ë..." : "ÎØ∏Î¶¨Î≥¥Í∏∞: ÎßàÏö∞Ïä§ Ïò§Î≤Ñ ‚Ä¢ ÏÉÅÌò∏ÏûëÏö©: ÌÅ¥Î¶≠"}
              </p>
            </div>

            <div className="pointer-events-auto max-w-[95vw]">
              <div className="bg-black/70 backdrop-blur-xl rounded-2xl lg:rounded-full p-2 shadow-2xl border border-white/10 flex items-center justify-center gap-2 overflow-x-auto custom-scrollbar ring-1 ring-white/20 w-fit mx-auto">
                  {GESTURES.map((gesture) => (
                  <button
                      key={gesture.id}
                      onClick={() => onSelectGesture(gesture)}
                      onMouseEnter={() => onHoverGesture(gesture)}
                      onMouseLeave={() => onHoverGesture(null)}
                      disabled={isLoading}
                      className={`
                          relative group flex flex-col items-center justify-center 
                          min-w-[64px] h-[64px] lg:min-w-[72px] lg:h-[72px] rounded-xl lg:rounded-full transition-all duration-300 flex-shrink-0
                          ${selectedGestureId === gesture.id ? 'bg-white text-black scale-105 shadow-[0_0_20px_rgba(255,255,255,0.3)]' : 'bg-white/5 text-white hover:bg-white/10'}
                          ${isLoading ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}
                      `}
                  >
                      <img 
                          src={gesture.icon} 
                          alt={gesture.label}
                          className="w-10 h-10 lg:w-12 lg:h-12 object-contain transition-transform duration-300 group-hover:scale-110 drop-shadow-md"
                      />
                      {selectedGestureId === gesture.id && (
                          <span className="absolute inset-0 rounded-xl lg:rounded-full border-2 border-white animate-ping opacity-20"></span>
                      )}
                  </button>
                  ))}
              </div>
            </div>
          </div>
        );
      };

      const GestureEncyclopedia = ({ onClose }) => {
        return (
          <div className="fixed inset-0 z-[60] bg-black/95 backdrop-blur-xl overflow-y-auto custom-scrollbar p-4 lg:p-10 animate-[fadeIn_0.3s_ease-out]">
              <button 
                  onClick={onClose} 
                  className="fixed top-24 right-6 z-50 text-white bg-white/10 hover:bg-white/20 hover:scale-110 border border-white/20 rounded-full p-3 transition-all duration-300"
              >
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-6 h-6">
                    <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
                  </svg>
              </button>
              
              <div className="text-center mt-10 mb-12">
                  <h2 className="text-4xl lg:text-5xl font-black text-white mb-2 uppercase tracking-tighter">Ï†úÏä§Ï≤ò Î∞±Í≥ºÏÇ¨Ï†Ñ</h2>
                  <p className="text-gray-400 uppercase tracking-[0.3em] text-xs lg:text-sm">Í∏ÄÎ°úÎ≤å ÏùòÎØ∏ Í∞ÄÏù¥Îìú</p>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 max-w-7xl mx-auto pb-20">
                  {GESTURES.map(gesture => (
                      <div key={gesture.id} className="bg-zinc-900/50 border border-white/10 rounded-2xl p-6 hover:bg-zinc-800/50 transition-all duration-300 hover:border-white/20 group">
                          <div className="flex items-center justify-center mb-6 border-b border-white/10 pb-4">
                              <div className="w-16 h-16 flex items-center justify-center bg-white/5 rounded-full p-2 group-hover:bg-white/10 transition-colors">
                                  <img 
                                      src={gesture.icon} 
                                      alt={gesture.label} 
                                      className="w-full h-full object-contain group-hover:scale-110 transition-transform duration-300"
                                  />
                              </div>
                          </div>
                          
                          <div className="space-y-3">
                              {gesture.culturalNote?.map((note, idx) => {
                                   const char = CHARACTERS.find(c => c.id === note.characterId);
                                   if (!char) return null;
                                   return (
                                       <div key={idx} className="flex justify-between items-start text-sm">
                                           <div className="flex items-center gap-2">
                                              <span className={`w-2 h-2 rounded-full ${note.isNegative ? 'bg-red-500' : 'bg-green-500'}`}></span>
                                              <span className="text-gray-400 font-medium shrink-0">{char.country}</span>
                                           </div>
                                           <span className={`text-right font-bold ${note.isNegative ? 'text-red-400' : 'text-emerald-400'}`}>
                                              {note.note}
                                           </span>
                                       </div>
                                   )
                              })}
                              {(!gesture.culturalNote || gesture.culturalNote.length === 0) && (
                                <p className="text-gray-600 text-sm italic">ÏùºÎ∞òÏ†ÅÏù∏ ÏÉÅÌô©ÏóêÏÑúÏùò Î≥¥Ìé∏Ï†Å ÏùòÎØ∏.</p>
                              )}
                          </div>
                      </div>
                  ))}
              </div>
          </div>
        );
      };

      // --- 5. Main App ---

      function App() {
        const [started, setStarted] = useState(false);
        const [showGuide, setShowGuide] = useState(false);
        const [currentReactions, setCurrentReactions] = useState([]);
        const [loading, setLoading] = useState(false);
        
        const [selectedGestureId, setSelectedGestureId] = useState(null);
        const [hoveredGestureId, setHoveredGestureId] = useState(null);
        
        const getCharacter = (id) => CHARACTERS.find(c => c.id === id);

        const activeCharacters = useMemo(() => {
          let targetId = hoveredGestureId || selectedGestureId;
          let ids = DEFAULT_CHARACTERS;

          if (targetId) {
             const g = GESTURES.find((g) => g.id === targetId);
             if (g && g.relatedCharacters) ids = g.relatedCharacters;
          }

          const chars = ids.map(id => getCharacter(id)).filter((c) => !!c);
          return chars.length >= 4 ? chars.slice(0, 4) : chars;
        }, [hoveredGestureId, selectedGestureId]);

        const handleGestureSelect = async (gesture) => {
          if (loading) return;

          setHoveredGestureId(null);
          setLoading(true);
          setSelectedGestureId(gesture.id);
          setCurrentReactions([]); 

          try {
            const reactions = await fetchReactions(gesture.prompt, activeCharacters);
            setCurrentReactions(reactions);
          } catch (err) {
            console.error("Failed to fetch reactions", err);
          } finally {
            setLoading(false);
          }
        };

        const handleHoverGesture = (gesture) => {
          if (!loading) {
              setHoveredGestureId(gesture?.id || null);
              if (gesture) setCurrentReactions([]);
          }
        };

        const getReactionForCharacter = (charId) => {
          return currentReactions.find(r => r.characterId === charId) || null;
        };

        return (
          <div className="relative w-full h-[100dvh] bg-black overflow-hidden font-sans">
             {/* INTRO SCREEN */}
             <div 
               onClick={() => setStarted(true)}
               className={`fixed inset-0 z-[100] bg-zinc-900 cursor-pointer transition-opacity duration-1000 ${started ? 'opacity-0 pointer-events-none' : 'opacity-100'}`}
             >
                <img 
                  src="https://i.imgur.com/tQVxKm8.png" 
                  alt="Title Screen" 
                  className="absolute inset-0 w-full h-full object-cover"
                />
                <div className="absolute inset-x-0 bottom-24 flex justify-center z-10">
                    <span className="text-white/80 text-xs lg:text-sm border border-white/40 bg-black/30 backdrop-blur-md px-10 py-4 rounded-full hover:bg-white hover:text-black transition-all hover:scale-105 tracking-[0.3em] uppercase shadow-2xl">
                        ENTER
                    </span>
                </div>
             </div>

            {started && (
              <button 
                  onClick={() => setShowGuide(true)}
                  className="fixed top-32 right-6 z-50 bg-white/10 hover:bg-white/20 backdrop-blur-md text-white p-3 rounded-full border border-white/10 transition-all duration-300 hover:scale-110 group"
                  title="Gesture Encyclopedia"
              >
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5 lg:w-6 lg:h-6">
                    <path strokeLinecap="round" strokeLinejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25" />
                  </svg>
                  <span className="absolute right-full mr-3 top-1/2 -translate-y-1/2 bg-white text-black text-[10px] font-bold px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none">
                      Î∞±Í≥ºÏÇ¨Ï†Ñ
                  </span>
              </button>
            )}

            {showGuide && <GestureEncyclopedia onClose={() => setShowGuide(false)} />}

            <div className={`flex flex-col lg:flex-row h-full w-full transition-opacity duration-1000 ${started ? 'opacity-100' : 'opacity-0'}`}>
              {activeCharacters.map((char, index) => (
                <div key={`${index}-${char.id}`} className="flex-1 relative border-b lg:border-b-0 lg:border-r border-white/10 last:border-0 overflow-hidden">
                  <CharacterStrip 
                      profile={char} 
                      reaction={getReactionForCharacter(char.id)}
                      isLoading={loading}
                  />
                </div>
              ))}
            </div>

            <div className={`transition-opacity duration-1000 ${started ? 'opacity-100' : 'opacity-0'}`}>
              <GestureControl 
                  onSelectGesture={handleGestureSelect}
                  onHoverGesture={handleHoverGesture}
                  isLoading={loading}
                  selectedGestureId={selectedGestureId}
              />
            </div>
          </div>
        );
      }

      const root = createRoot(document.getElementById('root'));
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );
    </script>
  <script type="module" src="/index.tsx"></script>
</body>
</html>